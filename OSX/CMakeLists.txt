project(Security.framework)

add_compile_options(
	-Wno-c++11-extensions
	#-Wno-implicit-function-declaration
	-Wno-deprecated
	-Wno-bool-conversion
	-Wno-null-conversion
	-Wno-enum-conversion
	-Wno-int-conversion
	-Wno-#warnings
	-Wno-mismatched-new-delete
)

add_subdirectory(libsecurity_keychain/libDER)
add_subdirectory(libsecurity_keychain/lib)
add_subdirectory(libsecurity_authorization/lib)
add_subdirectory(libsecurity_utilities/lib)
add_subdirectory(utilities/src)
add_subdirectory(libsecurity_cssm/lib)
add_subdirectory(libsecurity_transform/lib)
add_subdirectory(libsecurity_asn1/lib)
add_subdirectory(libsecurity_manifest/lib)
add_subdirectory(libsecurity_mds/lib)
add_subdirectory(libsecurity_sd_cspdl/lib)
add_subdirectory(libsecurity_smime/lib)
add_subdirectory(libsecurity_ssl/lib)
add_subdirectory(libsecurity_apple_csp)
add_subdirectory(libsecurity_apple_cspdl/lib)
add_subdirectory(libsecurity_apple_file_dl/lib)
add_subdirectory(libsecurity_apple_x509_cl/lib)
add_subdirectory(libsecurity_apple_x509_tp/lib)
add_subdirectory(libsecurity_cdsa_client/lib)
add_subdirectory(libsecurity_cdsa_plugin/lib)
add_subdirectory(libsecurity_cdsa_utilities/lib)
add_subdirectory(libsecurity_cdsa_utils/lib)
add_subdirectory(libsecurity_filedb/lib)
add_subdirectory(libsecurity_checkpw/lib)
add_subdirectory(libsecurity_cms/lib)
add_subdirectory(libsecurity_comcryption/lib)
add_subdirectory(libsecurity_codesigning)
add_subdirectory(libsecurity_cryptkit)
add_subdirectory(libsecurityd)
add_subdirectory(sec)
add_subdirectory(libsecurity_pkcs12/lib)
add_subdirectory(libsecurity_ocspd)
add_subdirectory(regressions/test)

make_fat(security_authorization)
make_fat(security_utilities)
make_fat(utilities)
make_fat(security_keychain)
make_fat(security_keychain_der)
make_fat(security_cssm)
make_fat(security_transform)
make_fat(security_asn1)
make_fat(security_manifest)
make_fat(security_mds)
make_fat(security_sd_cspdl)
make_fat(security_smime)
make_fat(security_ssl)
make_fat(security_apple_csp)
make_fat(security_apple_cspdl)
make_fat(security_apple_file_dl)
make_fat(security_apple_x509_cl)
make_fat(security_apple_x509_tp)
make_fat(security_cdsa_client)
make_fat(security_cdsa_plugin)
make_fat(security_cdsa_utilities)
make_fat(security_cdsa_utils)
make_fat(security_filedb)
make_fat(security_checkpw)
make_fat(security_cms)
make_fat(security_comcryption)
make_fat(security_codesigning)
make_fat(securityd_client)
make_fat(sec_item_shim)
make_fat(security_cryptkit)
make_fat(libsecurity_pkcs12)
make_fat(security_SecureObjectSync)
make_fat(security_SecTrustOSX)
make_fat(security_SecOtrOSX)
make_fat(libsecurity_ocspd)
make_fat(security_security)
make_fat(security_securityd)
make_fat(security_securityd_regressions)
make_fat(security_regressions)
make_fat(security_libsecd_regressions)

add_library(security_codesign_wrapper OBJECT
	../codesign_wrapper/codesign_wrapper.c
	../codesign_wrapper/codesign.c
	../codesign_wrapper/MISEntitlement.c
)
target_compile_definitions(security_codesign_wrapper PRIVATE INDIGO=1)
target_include_directories(security_codesign_wrapper PRIVATE
	${CMAKE_CURRENT_SOURCE_DIR}/../codesign_wrapper
)
make_fat(security_codesign_wrapper)
make_fat(security_secipc)

add_framework(Security
	FAT CURRENT_VERSION
	VERSION "A"
	SOURCES
	$<TARGET_OBJECTS:security_authorization>
	$<TARGET_OBJECTS:security_utilities>
	$<TARGET_OBJECTS:utilities>
	$<TARGET_OBJECTS:security_keychain>
	$<TARGET_OBJECTS:security_keychain_der>
	$<TARGET_OBJECTS:security_cssm>
	$<TARGET_OBJECTS:security_transform>
	$<TARGET_OBJECTS:security_asn1>
	$<TARGET_OBJECTS:security_manifest>
	$<TARGET_OBJECTS:security_mds>
	$<TARGET_OBJECTS:security_sd_cspdl>
	$<TARGET_OBJECTS:security_smime>
	$<TARGET_OBJECTS:security_ssl>
	$<TARGET_OBJECTS:security_apple_csp>
	$<TARGET_OBJECTS:security_apple_cspdl>
	$<TARGET_OBJECTS:security_apple_file_dl>
	$<TARGET_OBJECTS:security_apple_x509_cl>
	$<TARGET_OBJECTS:security_apple_x509_tp>
	$<TARGET_OBJECTS:security_cdsa_client>
	$<TARGET_OBJECTS:security_cdsa_plugin>
	$<TARGET_OBJECTS:security_cdsa_utilities>
	$<TARGET_OBJECTS:security_cdsa_utils>
	$<TARGET_OBJECTS:security_filedb>
	$<TARGET_OBJECTS:security_checkpw>
	$<TARGET_OBJECTS:security_cms>
	$<TARGET_OBJECTS:security_comcryption>
	$<TARGET_OBJECTS:security_codesigning>
	$<TARGET_OBJECTS:securityd_client>
	$<TARGET_OBJECTS:sec_item_shim>
	$<TARGET_OBJECTS:security_cryptkit>
	$<TARGET_OBJECTS:libsecurity_pkcs12>
	$<TARGET_OBJECTS:security_SecureObjectSync>
	$<TARGET_OBJECTS:security_SecTrustOSX>
	$<TARGET_OBJECTS:security_SecOtrOSX>
	$<TARGET_OBJECTS:libsecurity_ocspd>
	$<TARGET_OBJECTS:security_security>
	$<TARGET_OBJECTS:security_securityd>
	$<TARGET_OBJECTS:security_codesign_wrapper>
	$<TARGET_OBJECTS:security_secipc>
	$<TARGET_OBJECTS:security_securityd_regressions>
	$<TARGET_OBJECTS:security_regressions>
	$<TARGET_OBJECTS:security_libsecd_regressions>

	ExtraConstants.c

	DEPENDENCIES
		system
		system_coretls #Hack
		CoreFoundation
		sqlite3
		xpc
		pam.2
		cxx
		xpc
		xar
		z
		objc
		bsm.0
		SystemConfiguration
		AppleSystemInfo
		CryptoTokenKit
		LocalAuthentication
)
